"use strict";const video=document.getElementById("my-video"),btnRecognize=document.getElementById("btn-recognize"),userName=document.getElementById("user-name").value,userMail=document.getElementById("user-mail").value,recognizeResults=document.getElementById("recognize-result");let counter=0;const startVideo=()=>{navigator.mediaDevices.getUserMedia({video:{}}).then((e=>{video.srcObject=e})).catch((e=>console.error(e)))};Promise.all([faceapi.loadSsdMobilenetv1Model("/models"),faceapi.loadFaceRecognitionModel("/models"),faceapi.loadFaceLandmarkModel("/models")]).then(startVideo);const faceMatcher=async()=>{const e=await Promise.all(FACE_MODELS.map((e=>{e=JSON.parse(e);const t=[];for(let a=0;a<e.descriptors.length;a++)t.push(new Float32Array(e.descriptors[a]));return new faceapi.LabeledFaceDescriptors(e.label,t)})));return new faceapi.FaceMatcher(e,.8)},doRecognize=async()=>{video.paused&&(counter=1,video.play(),recognizeResults.innerHTML="");const e=faceapi.createCanvasFromMedia(video),t=document.getElementById("target-video"),a={width:video.offsetWidth,height:video.height};e.setAttribute("id","canvas-layer"),t.append(e),faceapi.matchDimensions(e,a);const o=await faceMatcher();setInterval((async()=>{const t=await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();if(null!=t){const n=faceapi.resizeResults(t,a),i=o.findBestMatch(t.descriptor);e.getContext("2d").clearRect(0,0,e.width,e.height),faceapi.draw.drawDetections(e,n);const c=n.detection.box,{label:d,distance:r}=i,s=USERS[d],l=100-parseInt(100*r,10);let g="",u="Valid";d!==userMail&&s!==userName&&(g='class="bg-danger text-white font-weight-bold"',u="Invalid");const m=`<tr ${g}><td>${counter}</td><td>${s}</td><td>${l}</td><td>${u}</td></tr>`;counter<=20&&(recognizeResults.innerHTML+=m,counter++),new faceapi.draw.DrawBox(c,{label:s}).draw(e)}else e.getContext("2d").clearRect(0,0,e.width,e.height);20===counter&&(stopVideo(),btnRecognize.innerText="Ulangi Uji Coba Pengenalan Wajah",document.querySelector("#btn-action").classList.remove("hidden"))}),100)};btnRecognize.addEventListener("click",doRecognize);const stopVideo=()=>{video.pause(),navigator.mediaDevices.getUserMedia({video:{}}).then((e=>{e.getTracks().forEach((e=>e.stop()))})).catch((e=>console.error(e)))};
